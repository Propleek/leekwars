include('auto');
stopOpk("loading lib");

if(getWeapon()==null) setWeapon(WEAPON_MAGNUM);

// charge les maps de chaque arme pour chaque adv
loadMapsDanger(10*1000*1000);
// génère la map complête de chaque adv à partir des maps d'armes.
finalizeMapsDanger();
// la map de tout le monde.
map_danger = getMapDanger([]);
colorMap();

//mes déplacements
reachableCells = getReachableCells([getCell():0], getMP(), []);

// préparation de la map des actions possibles
setMapActions();

// liste des combos à tester
var combos = [
	"magnum":[WEAPON_MAGNUM, WEAPON_MAGNUM],
	"spark":[CHIP_SPARK, CHIP_SPARK, CHIP_SPARK]
];

var best, score;
startOp();
for(var name:var combo in combos){
	var tmp = findBestMove(combo);
	debug("BEST for "+name+": " + tmp["score"]);
	if(best==null || best["score"] < tmp["score"]){
		best = tmp;
	}
}
stopOpk("findBestMove()");
debug("BEST: "+ best);
if(best!=null) playBestMove(best);
else moveTowardCell(getSafestCell());


function launchForAllAlly(chip){
	if(inArray(getChips(),chip)){
		for(var a in getAliveAllies()) if(!isSummon(a) && a!=getLeek()) useChip(chip, a);
		useChip(chip, getLeek());	
	}
}
function buff(){
	launchForAllAlly(CHIP_SHIELD);
	launchForAllAlly(CHIP_HELMET);
	if(getLife()<getTotalLife())launchForAllAlly(CHIP_CURE);
	if(getLife()<getTotalLife())launchForAllAlly(CHIP_BANDAGE);
	launchForAllAlly(CHIP_STRETCHING);
	launchForAllAlly(CHIP_PROTEIN);
	while(useChip(CHIP_SPARK, getNearestEnemy())>0);
}
buff();

debug('TOTALOP:' + round(getOperations()/1000) +"k");

// pour avoir le cout de la lib à chaque tour proprement.
__debug_operation=0;
